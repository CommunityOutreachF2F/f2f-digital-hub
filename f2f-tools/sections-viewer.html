<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Foundations to Freedom – Event Sections Library</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./sections.css">
  <style>
    body { background:#f7f7f7; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding:12px 18px;
      border-bottom:1px solid #eee;
      background:#fff;
    }
    .toolbar label { font-size:14px; color:#333; display:flex; align-items:center; gap:6px; }
    select, button, input[type="search"] {
      padding:8px 10px;
      border:1px solid #d6d6d6;
      border-radius:8px;
      background:#fff;
      font-size:14px;
    }
    input[type="search"] { min-width:220px; }
    .small { font-size:12px; color:#666; margin-left:auto; }
    #wrap { max-width:1100px; margin:0 auto 32px; padding:16px 12px 32px; }
    .msg {
      max-width:1100px;
      margin:16px auto;
      padding:12px 14px;
      border-radius:10px;
      background:#fff3cd;
      border:1px solid #ffeeba;
      color:#856404;
      font-size:14px;
    }
    .section-header {
      display:flex;
      gap:8px;
      align-items:center;
      margin:10px 0 6px;
      font-size:14px;
    }
    .section-header strong { font-family:monospace; }
    .section-header button {
      padding:6px 9px;
      font-size:13px;
      border-radius:8px;
      cursor:pointer;
    }
    .section-header a {
      padding:6px 9px;
      font-size:13px;
      border-radius:8px;
      border:1px solid #d0d0d0;
      text-decoration:none;
      color:#333;
      background:#fff;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      background:#eef5ff;
      color:#0b62d6;
      font-size:11px;
      margin-left:6px;
    }
    .preview {
      background:#fff;
      border-radius:12px;
      border:1px solid #e5e5e5;
      padding:14px 16px;
      box-shadow:0 4px 14px rgba(0,0,0,.03);
    }
    .search-hit-count {
      font-size:12px;
      color:#555;
      margin:0 0 8px 4px;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <label>
      <span><strong>Event:</strong></span>
      <select id="eventSel"></select>
    </label>

    <button id="reloadBtn" type="button">Reload</button>

    <label>
      <span>Search sections:</span>
      <input id="searchBox" type="search" placeholder="Search filename or text…">
    </label>

    <span class="small">Tip: Use “Copy HTML” to paste a section directly into Qgiv.</span>
  </div>

  <div id="message" class="msg" style="display:none;"></div>
  <div id="wrap">
    <p id="searchCount" class="search-hit-count" style="display:none;"></p>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const EVENTS_REGISTRY_URL = "../f2f-events/events.json";

  // Fallback in case events.json is missing
  const FALLBACK_EVENTS = [
    { slug: "virtual-giving-tree", label: "Virtual Giving Tree" },
    { slug: "2026-havana-nights", label: "2026 – Havana Nights Gala" }
  ];

  const wrap        = document.getElementById('wrap');
  const msgBox      = document.getElementById('message');
  const eventSel    = document.getElementById('eventSel');
  const reloadBtn   = document.getElementById('reloadBtn');
  const searchBox   = document.getElementById('searchBox');
  const searchCount = document.getElementById('searchCount');

  let EVENTS = [];
  let currentSlug = null;
  let sectionsData = []; // { file, html, element }

  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  function setParam(name, value) {
    const url = new URL(window.location.href);
    url.searchParams.set(name, value);
    window.history.replaceState({}, "", url);
  }

  function showMessage(text) {
    msgBox.textContent = text;
    msgBox.style.display = 'block';
  }

  function clearMessage() {
    msgBox.style.display = 'none';
    msgBox.textContent = '';
  }

  async function fetchText(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(path + ' → ' + res.status);
    return res.text();
  }

  async function fetchJSON(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(path + ' → ' + res.status);
    return res.json();
  }

  async function loadEventsRegistry() {
    try {
      const data = await fetchJSON(EVENTS_REGISTRY_URL);
      const list = (data.events || [])
        .filter(e => (e.status || "").toLowerCase() !== "template")
        .map(e => ({
          slug: e.id,
          label: e.name
        }))
        .filter(e => e.slug && e.label);

      return list.length ? list : FALLBACK_EVENTS;
    } catch (e) {
      console.warn("events.json not available, using fallback list.", e);
      return FALLBACK_EVENTS;
    }
  }

  function initEventSelect() {
    eventSel.innerHTML = '';
    EVENTS.forEach(ev => {
      const opt = document.createElement('option');
      opt.value = ev.slug;
      opt.textContent = ev.label;
      eventSel.appendChild(opt);
    });

    if (currentSlug) eventSel.value = currentSlug;
  }

  async function loadEvent(slug) {
    clearMessage();

    // Clear sections (leave the searchCount paragraph)
    wrap.querySelectorAll('section.section').forEach(s => s.remove());

    searchBox.value = '';
    searchCount.style.display = 'none';
    sectionsData = [];
    currentSlug = slug;

    if (!slug) {
      showMessage('No event selected.');
      return;
    }

    // base: ../f2f-events/<slug>/
    const base = `../f2f-events/${slug}/`;

    let meta;
    try {
      meta = await fetchJSON(base + 'meta.json');
    } catch (e) {
      console.error(e);
      showMessage(
        'Could not load meta.json for event "' + slug +
        '". Check that ../f2f-events/' + slug + '/meta.json exists and is valid JSON.'
      );
      return;
    }

    const order = meta.order || [];
    if (!order.length) {
      showMessage('meta.json has no "order" array or it is empty.');
      return;
    }

    for (const file of order) {
      try {
        const basePath = meta.base_path ? ("../" + meta.base_path) : (base + "html/");
        const html = await fetchText(basePath + file);

        const sec = document.createElement('section');
        sec.className = 'section';
        sec.dataset.file = file;

        sec.innerHTML = `
          <div class="section-header">
            <strong>${file}</strong>
            <span class="pill">HTML section</span>
            <button type="button" data-copy>Copy HTML</button>
            <a href="${basePath + file}" target="_blank" rel="noopener">Open file</a>
          </div>
          <div class="preview"></div>
        `;

        const preview = sec.querySelector('.preview');
        preview.innerHTML = html;

        const btn = sec.querySelector('[data-copy]');
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(html.trim());
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy HTML', 1000);
          } catch (err) {
            console.error(err);
            alert('Copy failed. You may need to copy manually from "Open file".');
          }
        });

        wrap.appendChild(sec);

        sectionsData.push({ file, html, element: sec });

      } catch (e) {
        console.error(e);
        showMessage(
          'Error loading section file "' + file +
          '". Check that it exists in ../f2f-events/' + slug + '/html/.'
        );
      }
    }

    applySearchFilter();
  }

  function applySearchFilter() {
    const query = (searchBox.value || '').toLowerCase().trim();

    if (!sectionsData.length) {
      searchCount.style.display = 'none';
      return;
    }

    let visibleCount = 0;

    sectionsData.forEach(({ file, element }) => {
      if (!query) {
        element.style.display = '';
        visibleCount++;
        return;
      }

      const haystack = (file + ' ' + element.textContent).toLowerCase();
      const match = haystack.includes(query);

      element.style.display = match ? '' : 'none';
      if (match) visibleCount++;
    });

    if (query) {
      searchCount.textContent = `${visibleCount} section(s) match “${query}”`;
      searchCount.style.display = 'block';
    } else {
      searchCount.style.display = 'none';
    }
  }

  reloadBtn.addEventListener('click', () => {
    loadEvent(eventSel.value);
  });

  eventSel.addEventListener('change', () => {
    const slug = eventSel.value;

    localStorage.setItem("f2f_last_event", slug);
    setParam("event", slug);

    loadEvent(slug);
  });

  searchBox.addEventListener('input', () => {
    applySearchFilter();
  });

  (async () => {
    EVENTS = await loadEventsRegistry();

    if (!EVENTS.length) {
      showMessage('No events configured.');
      return;
    }

    const urlEvent = getParam("event");
    const lastEvent = localStorage.getItem("f2f_last_event");
    currentSlug = urlEvent || lastEvent || EVENTS[0].slug;

    initEventSelect();
    eventSel.value = currentSlug;
    await loadEvent(currentSlug);
  })().catch(e => {
    console.error(e);
    showMessage('Startup error: ' + e.message);
  });
});
</script>
</body>
</html>
